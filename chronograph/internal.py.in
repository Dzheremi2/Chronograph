import logging
import os
import sys
from pathlib import Path

import gi

gi.require_version("Gdk", "4.0")
gi.require_version("GLib", "2.0")
from gi.repository import Gdk, GLib

from dgutils import Schema as _Schema

_PREFIX: str = "@PREFIX@"


# Windows workaround to stop pyinstaller from executing placeholder initiation before
# resources loaded
class ConstantsMeta(type):
  @property
  def COVER_PLACEHOLDER(cls) -> Gdk.Texture:  # noqa: N802
    if cls._cover_placeholder is None:
      cls._cover_placeholder = Gdk.Texture.new_from_resource(
        _PREFIX + "/icons/scalable/actions/note-placeholder.svg"
      )
    return cls._cover_placeholder


class Constants(metaclass=ConstantsMeta):
  _cover_placeholder = None

  # App directories
  match sys.platform:
    case "win32":
      dir = Path(GLib.get_user_config_dir()) / "Chronograph"
      CFG_DIR = dir / "config"
      DATA_DIR = dir / "data"
      CACHE_DIR = dir / "cache"
      CFG_DIR.mkdir(parents=True, exist_ok=True)
      DATA_DIR.mkdir(parents=True, exist_ok=True)
      CACHE_DIR.mkdir(parents=True, exist_ok=True)
      del dir
    case "linux":
      CFG_DIR = Path(GLib.get_user_config_dir())
      DATA_DIR = Path(GLib.get_user_data_dir())
      CACHE_DIR = Path(GLib.get_user_cache_dir())

  # Loggers
  LOGGER = logging.getLogger("APP")
  PLAYER_LOGGER = logging.getLogger("GST_PLAYER")
  LRCLIB_LOGGER = logging.getLogger("LRCLIB")
  FILE_LOGGER = logging.getLogger("FILE_MANAGER")
  DB_LOGGER = logging.getLogger("DB")

  # App metadata
  APP_ID = "@APP_ID@"
  VERSION = "@VERSION@"
  PREFIX = "@PREFIX@"
  CACHEV = int("@CACHEV@")
  DB_VER = int("@DBVER@")

  # Shared variables
  APP = None
  WIN = None
  CACHE_FILE = None
  CACHE = None


match sys.platform:
  case "win32":
    Schema = _Schema(
      _PREFIX + "/resources/schema.yaml",
      Constants.CFG_DIR / "schema",
    )
  case "linux":
    Schema = _Schema(
      _PREFIX + "/resources/schema.yaml",
      Path(os.path.join(GLib.get_user_config_dir(), "chronograph", "schema")),
    )
