name: Publish Release
on:
  push:
    tags: 
      - "*"
  workflow_dispatch:

permissions:
  actions: read
  contents: write

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  publish-release:
    name: Publish Release
    runs-on: ubuntu-latest
    steps:
      - name: Wait for release builds
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const sha = context.sha;
            const workflows = [
              'build-release-linux.yml',
              'build-release-windows.yml',
            ];
            const timeoutMs = 60 * 60 * 1000;
            const intervalMs = 30 * 1000;
            const sleep = (ms) => new Promise((resolve) => setTimeout(resolve, ms));
            const started = Date.now();

            while (Date.now() - started < timeoutMs) {
              let allDone = true;
              for (const workflow of workflows) {
                const runs = await github.rest.actions.listWorkflowRuns({
                  owner,
                  repo,
                  workflow_id: workflow,
                  head_sha: sha,
                  per_page: 1,
                });

                if (runs.data.workflow_runs.length === 0) {
                  allDone = false;
                  continue;
                }

                const run = runs.data.workflow_runs[0];
                if (run.status !== 'completed') {
                  allDone = false;
                  continue;
                }

                if (run.conclusion !== 'success') {
                  core.setFailed(`Workflow ${workflow} finished with ${run.conclusion}`);
                  return;
                }
              }

              if (allDone) {
                core.info('Windows and Flatpak builds completed.');
                return;
              }

              core.info('Waiting for release builds to finish...');
              await sleep(intervalMs);
            }

            core.setFailed('Timed out waiting for release builds.');

      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Linux artifact
        uses: dawidd6/action-download-artifact@v9
        with:
          workflow: build-release-linux.yml
          commit: ${{ github.sha }}

      - name: Download Windows artifact
        uses: dawidd6/action-download-artifact@v9
        with:
          workflow: build-release-windows.yml
          commit: ${{ github.sha }}

      - name: Get release notes
        shell: python
        run: |
          import re, textwrap, sys
          try:
              with open("./docs/CHANGELOG.md", "r", encoding="utf-8") as f:
                  changelog_content = f.read()
          except FileNotFoundError:
              print("Error: docs/CHANGELOG.md not found.", file=sys.stderr)
              sys.exit(1)
          pattern = re.compile(
              r'^##\s*\d+\.\d+\.?\d*(?:\-rc\d*)?\s*\n'
              r'([\s\S]*?)'
              r'(?=^##\s*\d+\.\d+|\Z)',
              re.MULTILINE
          )
          match = pattern.search(changelog_content)
          if not match:
              print("Error: Could not extract release notes. Check CHANGELOG format.", file=sys.stderr)
              sys.exit(1)
          notes = match.group(1)
          notes = textwrap.dedent(notes).strip()
          with open("release_notes", "w", encoding="utf-8") as f:
              f.write("## Release Notes\n")
              f.write(notes)
              f.write("\n\n## Windows Info\nLogs are located at `C:\\Users\\{username}\\AppData\\Local\\chronograph\\cache\\logs`\nConfig located at `C:\\Users\\{username}\\AppData\\Local\\chronograph\\config`\nUser data located at `C:\\Users\\{username}\\AppData\\Local\\chronograph\\data`")
              f.write("\n\nSee [full changelog](https://github.com/Dzheremi2/Chronograph/blob/main/docs/CHANGELOG.md) for previous releases changes")

      - name: Get tag name
        id: get_tag_name
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo tag_name=v5.3.2 >> $GITHUB_OUTPUT
          else
            echo tag_name=${GITHUB_REF#refs/tags/} >> $GITHUB_OUTPUT
          fi

      - name: Rename release files
        run: |
          mv io.github.dzheremi2.lrcmake-gtk-x86_64/io.github.dzheremi2.lrcmake-gtk.flatpak io.github.dzheremi2.lrcmake-gtk-x86_64.flatpak
          mv io.github.dzheremi2.lrcmake-gtk-aarch64/io.github.dzheremi2.lrcmake-gtk.flatpak io.github.dzheremi2.lrcmake-gtk-aarch64.flatpak
          mv Chronograph-Windows-exe/Chronograph.exe Chronograph.exe

      - name: Publish release
        uses: softprops/action-gh-release@v2.2.1
        with:
          files: |
            io.github.dzheremi2.lrcmake-gtk-x86_64.flatpak
            io.github.dzheremi2.lrcmake-gtk-aarch64.flatpak
            Chronograph.exe
          fail_on_unmatched_files: true
          tag_name: ${{ steps.get_tag_name.outputs.tag_name }}
          body_path: release_notes
          prerelease: ${{ contains(steps.get_tag_name.outputs.tag_name, '-rc') }}
