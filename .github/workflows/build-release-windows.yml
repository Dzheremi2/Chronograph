name: Release Windows

on:
  push:
    branches:
      - "main"
  workflow_dispatch:

jobs:
  build-windows:
    runs-on: windows-latest
    name: Build Release Windows
    
    defaults:
      run:
        shell: msys2 {0}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup MSYS2 (UCRT64 + Cache)
        uses: msys2/setup-msys2@v2
        with:
          msystem: UCRT64
          update: true
          install: >-
            git
            mingw-w64-ucrt-x86_64-gcc
            mingw-w64-ucrt-x86_64-meson
            mingw-w64-ucrt-x86_64-ninja
            mingw-w64-ucrt-x86_64-gtk4
            mingw-w64-ucrt-x86_64-libadwaita
            mingw-w64-ucrt-x86_64-python
            mingw-w64-ucrt-x86_64-python-gobject
            mingw-w64-ucrt-x86_64-python-pip
            mingw-w64-ucrt-x86_64-blueprint-compiler
            mingw-w64-ucrt-x86_64-python-mutagen
            mingw-w64-ucrt-x86_64-python-requests
            mingw-w64-ucrt-x86_64-adwaita-icon-theme
            mingw-w64-ucrt-x86_64-desktop-file-utils
            mingw-w64-ucrt-x86_64-appstream
            mingw-w64-ucrt-x86_64-file
            mingw-w64-ucrt-x86_64-gstreamer
            mingw-w64-ucrt-x86_64-gst-plugins-base
            mingw-w64-ucrt-x86_64-gst-plugins-good
            mingw-w64-ucrt-x86_64-gst-plugins-bad
            mingw-w64-ucrt-x86_64-gst-plugins-ugly
            mingw-w64-ucrt-x86_64-gst-libav
            mingw-w64-ucrt-x86_64-imagemagick

      - name: Build Resources (Meson)
        shell: msys2 {0}
        env:
          REPO_DIR: ${{ github.workspace }}
          PYTHONUTF8: "1"
        run: |
          cd "$REPO_DIR"
          mkdir -p /usr/share/gettext/its
          cp -r /ucrt64/share/gettext/its/* /usr/share/gettext/its/ || echo "Copy failed"
          export GETTEXTDATADIRS="/ucrt64/share/gettext"
          export GI_TYPELIB_PATH=$(cygpath -m /ucrt64/lib/girepository-1.0)
          meson setup build
          meson compile -C build
      - name: Generate Windows Icon
        shell: msys2 {0}
        env:
          REPO_DIR: ${{ github.workspace }}
        run: |
          cd "$REPO_DIR"
          ICON_SVG=$(find data/icons -name "io.github.dzheremi2.lrcmake-gtk.svg" | head -n 1)
          if [ -z "$ICON_SVG" ]; then ICON_SVG=$(find data/icons -name "*.svg" | grep "apps" | head -n 1); fi
          if [ -z "$ICON_SVG" ]; then ICON_SVG=$(find data/icons -name "*.svg" | head -n 1); fi
          if [ -n "$ICON_SVG" ]; then
            magick -background none "$ICON_SVG" -define icon:auto-resize=256,128,64,48,32,16 app.ico
          fi

      - name: Bundle with PyInstaller
        shell: msys2 {0}
        env:
          REPO_DIR: ${{ github.workspace }}
          PYTHONUTF8: "1"
        run: |
          cd "$REPO_DIR"
          
          pip install pyinstaller pyyaml mutagen requests pillow python-magic httpx pycairo websockets chardet idna certifi urllib3 --break-system-packages
          
          find build -name "internal.py"
          cp build/chronograph/internal.py chronograph/internal.py || cp build/src/chronograph/internal.py chronograph/internal.py || echo "WARNING: internal.py not found"
          find build -name "*.gresource"
          cp build/data/Chronograph.gresource Chronograph.gresource || echo "WARNING: GResource not found"
          mkdir -p data/resources
          if [ -f build/data/resources/constants.yaml ]; then
             cp build/data/resources/constants.yaml data/resources/constants.yaml
          fi

          gdk-pixbuf-query-loaders | sed 's|"[^"]*[\\/]\([^"\\/]*\.dll\)"|"\1"|' > loaders.cache
          PIXBUF_DIR=$(cygpath -m /ucrt64/lib/gdk-pixbuf-2.0/2.10.0)
          GST_PLUGIN_DIR=$(cygpath -m /ucrt64/lib/gstreamer-1.0)
          GST_SCANNER_BIN=$(find /ucrt64 -name "gst-plugin-scanner.exe" | head -n 1)
          
          RSVG_DLL=$(find /ucrt64/bin -name "librsvg-2-*.dll" | head -n 1)
          XML2_DLL=$(find /ucrt64/bin -name "libxml2-*.dll" | head -n 1)
          ORC_DLL=$(find /ucrt64/bin -name "liborc-*.dll" | head -n 1)
          PTHREAD_DLL=$(find /ucrt64/bin -name "libwinpthread-*.dll" | head -n 1)
          INTL_DLL=$(find /ucrt64/bin -name "libintl-*.dll" | head -n 1)
          
          ICON_PATH=$(cygpath -w "$REPO_DIR/app.ico")
          TYPELIB_PATH=$(cygpath -w /ucrt64/lib/girepository-1.0)
          GI_OVERRIDES_PATH=$(python3 -c "import gi.overrides; print(gi.overrides.__path__[0])")

          cat > rthook_gi.py <<EOF
          import os, sys
          if hasattr(sys, '_MEIPASS'):
              os.environ['PATH'] = sys._MEIPASS + os.pathsep + os.environ.get('PATH', '')
              os.environ['GDK_PIXBUF_MODULE_FILE'] = os.path.join(sys._MEIPASS, 'loaders.cache')
              os.environ['GDK_PIXBUF_MODULEDIR'] = sys._MEIPASS
              os.environ['GI_TYPELIB_PATH'] = os.path.join(sys._MEIPASS, 'lib', 'girepository-1.0')
              os.environ['GDK_BACKEND'] = 'win32'
              gst_plugins = os.path.join(sys._MEIPASS, 'gst-plugins')
              os.environ['GST_PLUGIN_PATH'] = gst_plugins
              os.environ['GST_PLUGIN_SYSTEM_PATH'] = gst_plugins
              os.environ['GST_REGISTRY'] = os.path.join(sys._MEIPASS, 'registry.bin')
              os.environ['GST_PLUGIN_SCANNER'] = os.path.join(sys._MEIPASS, 'gst-plugin-scanner.exe')
              try:
                  import gi
                  import gi.overrides.Gtk
                  import gi.overrides.Gio
                  from gi.repository import Gio
                  resource_path = os.path.join(sys._MEIPASS, 'Chronograph.gresource')
                  if os.path.exists(resource_path):
                      Gio.Resource.load(resource_path)._register()
              except Exception: pass
          EOF
          
          pyinstaller --noconsole --onefile --name Chronograph \
            --icon="$ICON_PATH" \
            --add-data "data:data" \
            --add-data "dgutils:dgutils" \
            --add-data "data/resources:data/resources" \
            --add-data "$TYPELIB_PATH:lib/girepository-1.0" \
            --add-data "Chronograph.gresource:." \
            --add-data "$GI_OVERRIDES_PATH:gi/overrides" \
            --add-data "loaders.cache:." \
            --add-binary "$PIXBUF_DIR/loaders/*.dll:." \
            --add-binary "$GST_PLUGIN_DIR/*.dll:gst-plugins" \
            --add-binary "$GST_SCANNER_BIN:." \
            --add-binary "$RSVG_DLL:." \
            --add-binary "$XML2_DLL:." \
            --add-binary "$ORC_DLL:." \
            --add-binary "$PTHREAD_DLL:." \
            --add-binary "$INTL_DLL:." \
            --runtime-hook="rthook_gi.py" \
            --hidden-import="gi" \
            --hidden-import="gi.overrides" \
            --hidden-import="gi.overrides.Gtk" \
            --hidden-import="gi.overrides.Gio" \
            --hidden-import="gi.overrides.GObject" \
            --hidden-import="gi.repository.Gtk" \
            --hidden-import="cairo" \
            --collect-all="mutagen" \
            --collect-all="requests" \
            --collect-all="yaml" \
            --collect-all="PIL" \
            --collect-all="magic" \
            --collect-all="httpx" \
            --collect-all="chardet" \
            --collect-all="certifi" \
            --collect-all="idna" \
            --collect-all="urllib3" \
            --add-binary "/ucrt64/bin/libmagic-1.dll:." \
            build-aux/windows/launcher.py

      - name: Upload Windows Artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: Chronograph-Windows-exe
          path: dist/Chronograph.exe
